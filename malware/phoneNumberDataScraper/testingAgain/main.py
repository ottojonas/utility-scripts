import folium
import geocoder
import phonenumbers
import requests
from geopy.geocoders import Nominatim
from icecream import ic
from opencage.geocoder import OpenCageGeocode
from phonenumbers import carrier as phone_carrier
from phonenumbers import geocoder as phone_geocoder

# opencage api key
apiKey = "52899a4107b54635a91e6d84c7c7a1a6"

# get current gps coords using geopy
geolocator = Nominatim(user_agent="geoapiExercise")
location = geolocator.geocode("")

if not location:
    ip_response = requests.get("https://api.ipify.org?format=json")
    ip_address = ip_response.json()["ip"]
    g = geocoder.ip(ip_address)
    lat, lng = g.latlng
else:
    lat, lng = location.latitude, location.longitude
ic(ip_address)
ic(lat, lng)

# use gps coords to get location description
oc_geocoder = OpenCageGeocode(apiKey)
result = oc_geocoder.reverse_geocode(lat, lng)
location_description = result[0]["formatted"]
ic(location_description)
ic(result)

# get phone number details
number = input("Enter phone number with country code (e.g., +44 07123456789): ")
parsed_number = phonenumbers.parse(number)
region = phone_geocoder.description_for_number(parsed_number, "en")
service_name = phone_carrier.name_for_number(parsed_number, "en")
ic(region)
ic(service_name)

# create map centered on current gps coords
my_map = folium.Map(location=[lat, lng], zoom_start=9)
folium.Marker([lat, lng], popup=location_description).add_to(my_map)

my_map.save("location.html")
ic("Map has been saved")
